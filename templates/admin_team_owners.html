{{define "title"}}Team & User Management{{end}}

{{define "content"}}
<div class="content-container">
    <h2>Team & User Management</h2>

    {{if .SaveSuccess}}
    <div style="background: #d4edda; color: #155724; padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
        Changes saved successfully.
    </div>
    {{end}}

    <h3>Current Team Owners</h3>
    <table class="fantasy-table-base">
        <thead>
            <tr>
                <th>Team</th>
                <th>League</th>
                <th>Username</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Owners}}
            <tr>
                <td><strong>{{.TeamName}}</strong></td>
                <td>{{.LeagueName}}</td>
                <td>{{.Username}}</td>
                <td>{{.Email}}</td>
                <td>
                    <form action="/admin/team-owners/remove" method="POST" style="display: inline;" onsubmit="return confirm('Remove {{.Username}} from {{.TeamName}}?');">
                        <input type="hidden" name="team_id" value="{{.TeamID}}">
                        <input type="hidden" name="user_id" value="{{.UserID}}">
                        <button type="submit" class="button button-small" style="background: #d9534f;">Remove</button>
                    </form>
                </td>
            </tr>
            {{else}}
            <tr><td colspan="5">No team owners found.</td></tr>
            {{end}}
        </tbody>
    </table>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
        <div style="background: white; border: 1px solid #ddd; padding: 20px; border-radius: 8px; border-top: 4px solid var(--fod-blue-primary);">
            <h3 style="margin-top: 0;">Add Owner to Team</h3>
            <form action="/admin/team-owners/add" method="POST">
                <div style="margin-bottom: 12px;">
                    <label><strong>Team</strong></label><br>
                    <select name="team_id" required style="width: 100%; padding: 8px; margin-top: 4px;">
                        <option value="">-- Select Team --</option>
                        {{range .Leagues}}
                        <optgroup label="{{.Name}}">
                            {{range .Teams}}
                            <option value="{{.ID}}">{{.Name}}</option>
                            {{end}}
                        </optgroup>
                        {{end}}
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label><strong>User</strong></label><br>
                    <select name="user_id" required style="width: 100%; padding: 8px; margin-top: 4px;">
                        <option value="">-- Select User --</option>
                        {{range .AllUsers}}
                        <option value="{{.ID}}">{{.Username}} ({{.Email}})</option>
                        {{end}}
                    </select>
                </div>
                <button type="submit" class="button">Add Owner</button>
            </form>
        </div>

        <div style="background: white; border: 1px solid #ddd; padding: 20px; border-radius: 8px; border-top: 4px solid #5cb85c;">
            <h3 style="margin-top: 0;">Create New User</h3>
            <form action="/admin/team-owners/create-user" method="POST">
                <div style="margin-bottom: 12px;">
                    <label><strong>Username</strong></label><br>
                    <input type="text" name="username" required style="width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label><strong>Email</strong></label><br>
                    <input type="email" name="email" required style="width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label><strong>Password</strong></label><br>
                    <input type="password" name="password" required minlength="6" style="width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box;">
                </div>
                <button type="submit" class="button" style="background: #5cb85c;">Create User</button>
            </form>
        </div>
    </div>

    <h3 style="margin-top: 40px;">All Users</h3>
    <table class="fantasy-table-base">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .AllUsers}}
            <tr>
                <td><strong>{{.Username}}</strong></td>
                <td>{{.Email}}</td>
                <td>{{.Role}}</td>
                <td>{{.CreatedAt.Format "2006-01-02"}}</td>
                <td>
                    {{if eq .ID $.User.ID}}
                    <span style="color: #999;">You</span>
                    {{else}}
                    <button type="button" class="button button-small" style="background: #f0ad4e;" onclick="openResetModal('{{.ID}}', '{{.Username}}')">Reset Password</button>
                    <form action="/admin/team-owners/delete-user" method="POST" style="display: inline;" onsubmit="return confirm('Delete user {{.Username}}? This will remove all team ownership and sessions.');">
                        <input type="hidden" name="user_id" value="{{.ID}}">
                        <button type="submit" class="button button-small" style="background: #d9534f;">Delete</button>
                    </form>
                    {{end}}
                </td>
            </tr>
            {{else}}
            <tr><td colspan="5">No users found.</td></tr>
            {{end}}
        </tbody>
    </table>
    <!-- Reset Password Modal -->
    <div id="resetModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:white; padding:24px; border-radius:8px; max-width:400px; width:90%; margin:auto; position:relative; top:50%; transform:translateY(-50%);">
            <h3 style="margin-top:0;">Reset Password</h3>
            <p>Set a new password for <strong id="resetUsername"></strong></p>
            <input type="hidden" id="resetUserId">
            <div style="margin-bottom:12px;">
                <label><strong>New Password</strong></label><br>
                <input type="password" id="resetNewPassword" minlength="6" style="width:100%; padding:8px; margin-top:4px; box-sizing:border-box;">
            </div>
            <div id="resetMessage" style="display:none; padding:10px; border-radius:6px; margin-bottom:12px;"></div>
            <div style="display:flex; gap:10px;">
                <button class="button" onclick="submitResetPassword()">Reset Password</button>
                <button class="button" style="background:#999;" onclick="closeResetModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
function openResetModal(userId, username) {
    document.getElementById('resetUserId').value = userId;
    document.getElementById('resetUsername').textContent = username;
    document.getElementById('resetNewPassword').value = '';
    document.getElementById('resetMessage').style.display = 'none';
    document.getElementById('resetModal').style.display = 'block';
}

function closeResetModal() {
    document.getElementById('resetModal').style.display = 'none';
}

function submitResetPassword() {
    var userId = document.getElementById('resetUserId').value;
    var newPassword = document.getElementById('resetNewPassword').value;
    var msgEl = document.getElementById('resetMessage');

    if (!newPassword || newPassword.length < 6) {
        msgEl.style.display = 'block';
        msgEl.style.background = '#f8d7da';
        msgEl.style.color = '#721c24';
        msgEl.textContent = 'Password must be at least 6 characters.';
        return;
    }

    var formData = new FormData();
    formData.append('user_id', userId);
    formData.append('new_password', newPassword);

    fetch('/admin/reset-user-password', { method: 'POST', body: formData })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                msgEl.style.display = 'block';
                msgEl.style.background = '#f8d7da';
                msgEl.style.color = '#721c24';
                msgEl.textContent = data.error;
            } else {
                msgEl.style.display = 'block';
                msgEl.style.background = '#d4edda';
                msgEl.style.color = '#155724';
                msgEl.textContent = data.message;
                document.getElementById('resetNewPassword').value = '';
                setTimeout(closeResetModal, 1500);
            }
        })
        .catch(function() {
            msgEl.style.display = 'block';
            msgEl.style.background = '#f8d7da';
            msgEl.style.color = '#721c24';
            msgEl.textContent = 'Failed to reset password.';
        });
}

document.getElementById('resetModal').addEventListener('click', function(e) {
    if (e.target === this) closeResetModal();
});
</script>
{{end}}
