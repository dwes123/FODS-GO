{{define "title"}}{{.Team.Name}} Roster{{end}}

{{define "content"}}
<div class="team-header">
    <h2>{{.Team.Name}}</h2>
    <p>Owner: {{.Team.Owner}} | ISBP Balance: ${{formatMoney .Team.IsbpBalance}}</p>
    {{if .User}}
        {{if ne .User.ID .Team.UserID}}
            <a href="/trades/new?team_id={{.Team.ID}}" class="button button-info">Propose Trade</a>
        {{end}}
    {{end}}
</div>

<h3>Team Financials</h3>
<div class="table-container">
    <table class="fantasy-table-base sticky-col">
        <thead>
            <tr>
                <th>Year</th>
                {{range .Team.Years}}<th>{{.}}</th>{{end}}
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Active Payroll</strong></td>
                {{range .Team.SalarySummary}}<td>${{formatMoney .ActivePayroll}}</td>{{end}}
            </tr>
            <tr>
                <td><strong>Dead Cap</strong></td>
                {{range .Team.SalarySummary}}<td>${{formatMoney .DeadCap}}</td>{{end}}
            </tr>
            <tr class="total-row">
                <td><strong>Total Payroll</strong></td>
                {{range .Team.SalarySummary}}<td><strong>${{formatMoney .TotalPayroll}}</strong></td>{{end}}
            </tr>
            <tr>
                <td><strong>Luxury Tax Limit</strong></td>
                {{range .Team.SalarySummary}}<td>${{formatMoney .LuxuryTaxLimit}}</td>{{end}}
            </tr>
            <tr>
                <td><strong>Tax Space (+/-)</strong></td>
                {{range .Team.SalarySummary}}
                <td style="color: {{if lt .TaxSpace 0.0}}red{{else}}green{{end}};">
                    <strong>${{formatMoney .TaxSpace}}</strong>
                </td>
                {{end}}
            </tr>
        </tbody>
    </table>
</div>

{{$isOwner := false}}
{{if .User}}
    {{if eq .User.ID .Team.UserID}}
        {{$isOwner = true}}
    {{end}}
{{end}}
{{$years := .Team.Years}}
{{$posOrder := .PosOrder}}

<div class="roster-section">
    <h2 class="section-title">26-Man Roster</h2>
    {{template "roster_table" dict "Grouped" .Roster26 "PosOrder" $posOrder "Years" $years "IsOwner" $isOwner "TeamID" .Team.ID}}
</div>

<div class="roster-section">
    <h2 class="section-title">40-Man Roster (Minors)</h2>
    {{template "roster_table" dict "Grouped" .Roster40 "PosOrder" $posOrder "Years" $years "IsOwner" $isOwner "TeamID" .Team.ID}}
</div>

<div class="roster-section">
    <h2 class="section-title">Minor Leagues (Non-40)</h2>
    {{template "roster_table" dict "Grouped" .Minors "PosOrder" $posOrder "Years" $years "IsOwner" $isOwner "TeamID" .Team.ID}}
</div>

<!-- Modals -->
<dialog id="ilModal" class="modal">
    <h3>Move to Injured List</h3>
    <form method="dialog">
        <label>Duration:</label>
        <select id="ilDuration">
            <option value="10">10-Day IL</option>
            <option value="15">15-Day IL</option>
            <option value="60">60-Day IL (Removes from 40-man)</option>
        </select>
        <div class="modal-actions">
            <button value="cancel">Cancel</button>
            <button id="confirmILBtn" value="confirm">Confirm</button>
        </div>
    </form>
</dialog>

<dialog id="dfaModal" class="modal">
    <h3>Designate for Assignment</h3>
    <p>If this player clears waivers (no claims), what should happen?</p>
    <form method="dialog">
        <label>Clear Action:</label>
        <select id="dfaClearAction">
            <option value="release">Release (dead cap: 75% current year, 50% future)</option>
            <option value="minors">Send to Minors (off 40-man, stays on team)</option>
        </select>
        <div class="modal-actions">
            <button value="cancel">Cancel</button>
            <button id="confirmDFABtn" value="confirm" class="button button-danger">Confirm DFA</button>
        </div>
    </form>
</dialog>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
let currentPlayerID = null;
let currentTeamID = null;

async function movePlayer(type, playerID, teamID) {
    if (!confirm('Are you sure?')) return;
    await sendRequest(`/roster/move/${type}`, { player_id: playerID, team_id: teamID });
}

function openILModal(playerID, teamID) {
    currentPlayerID = playerID;
    currentTeamID = teamID;
    document.getElementById('ilModal').showModal();
}

function openDFAModal(playerID, teamID) {
    currentPlayerID = playerID;
    currentTeamID = teamID;
    document.getElementById('dfaModal').showModal();
}

document.getElementById('confirmILBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const duration = document.getElementById('ilDuration').value;
    await sendRequest('/roster/move/il', { player_id: currentPlayerID, team_id: currentTeamID, duration: duration });
    document.getElementById('ilModal').close();
});

document.getElementById('confirmDFABtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const clearAction = document.getElementById('dfaClearAction').value;
    await sendRequest('/roster/move/dfa', { player_id: currentPlayerID, team_id: currentTeamID, dfa_clear_action: clearAction });
    document.getElementById('dfaModal').close();
});

async function sendRequest(url, data) {
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const res = await response.json();
        if (response.ok) {
            alert(res.message);
            location.reload();
        } else {
            alert("Error: " + res.error);
        }
    } catch (e) {
        console.error(e);
        alert("Request failed");
    }
}

async function toggleTradeBlock(playerID, teamID, onBlock) {
    const notes = onBlock ? prompt('Trade block notes (optional):') || '' : '';
    await sendRequest('/roster/move/trade-block', { player_id: playerID, team_id: teamID, on_block: onBlock, notes: notes });
}

// --- Depth Chart Sorting (Feature 21) ---
{{if $isOwner}}
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.roster-sortable tbody').forEach(function(tbody) {
        new Sortable(tbody, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            onEnd: function() {
                // Collect new order from all sortable tables
                saveDepthOrder();
            }
        });
    });
});

async function saveDepthOrder() {
    const order = [];
    document.querySelectorAll('.roster-sortable tbody tr[data-player-id]').forEach(function(row, idx) {
        order.push(row.getAttribute('data-player-id'));
    });
    if (order.length === 0) return;

    try {
        const response = await fetch('/roster/depth-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team_id: '{{.Team.ID}}', order: order })
        });
        const res = await response.json();
        if (!response.ok) {
            alert("Error saving order: " + res.error);
        }
    } catch (e) {
        console.error('Failed to save depth order:', e);
    }
}
{{end}}
</script>

<style>
    .section-title { margin-top: 3rem; background: var(--fod-blue-primary); color: white; padding: 10px 20px; border-radius: 8px 8px 0 0; }
    .table-container { width: 100%; margin-bottom: 2rem; border: 1px solid #ddd; border-radius: 0 0 8px 8px; }
    .fantasy-table-base { width: 100%; margin: 0; border: none; }
    .total-row { background-color: #eee !important; font-size: 1.1rem; }
    .action-buttons { display: flex; gap: 3px; }
    .action-buttons .button { padding: 4px 8px; font-size: 0.75rem; min-width: 40px; text-align: center; }
    .button-secondary { background-color: #6c757d; }
    .button-danger { background-color: #dc3545; }
    .button-info { background-color: #17a2b8; }
    .button-warning { background-color: #ffc107; color: #333; }
    .modal { padding: 20px; border-radius: 8px; border: 1px solid #ccc; }
    a.button { text-decoration: none; display: inline-block; }
    .sortable-ghost { background-color: #e3f2fd !important; opacity: 0.8; }
    .drag-handle:hover { color: var(--fod-blue-primary); }
    .option-year { background-color: rgba(232, 116, 38, 0.15) !important; border-left: 2px solid var(--fod-orange-accent); }
</style>
{{end}}

<!-- Define a reusable roster table template outside the content block -->
{{define "roster_table"}}
    {{$grouped := .Grouped}}
    {{$years := .Years}}
    {{$isOwner := .IsOwner}}
    {{$teamID := .TeamID}}
    
    <div class="table-container">
        <table class="fantasy-table-base roster-sortable">
            <thead>
                <tr>
                    {{if $isOwner}}<th style="width:30px"></th>{{end}}
                    <th>Actions</th>
                    <th>Name</th>
                    <th>Pos</th>
                    <th>MLB</th>
                    <th>Status</th>
                    {{range $years}}<th>{{.}}</th>{{end}}
                </tr>
            </thead>
            <tbody>
                {{range .PosOrder}}
                    {{$players := index $grouped .}}
                    {{range $players}}
                    <tr data-player-id="{{.ID}}">
                        {{if $isOwner}}<td class="drag-handle" style="cursor: grab; text-align: center;">&#9776;</td>{{end}}
                        <td>
                            <div class="action-buttons">
                                <a href="/player/{{.ID}}" class="button button-info">View</a>
                                {{if $isOwner}}
                                    {{if .StatusIL}}
                                        <button class="button" onclick="movePlayer('activate', '{{.ID}}', '{{$teamID}}')">Activate</button>
                                    {{else}}
                                        {{if .Status40Man}}
                                            {{if not .Status26Man}}
                                                <button class="button" onclick="movePlayer('26man', '{{.ID}}', '{{$teamID}}')">26</button>
                                            {{else}}
                                                <button class="button" onclick="movePlayer('option', '{{.ID}}', '{{$teamID}}')">Opt</button>
                                            {{end}}
                                        {{else}}
                                            <button class="button" onclick="movePlayer('40man', '{{.ID}}', '{{$teamID}}')">40</button>
                                        {{end}}
                                        <button class="button button-secondary" onclick="openILModal('{{.ID}}', '{{$teamID}}')">IL</button>
                                        <button class="button button-danger" onclick="openDFAModal('{{.ID}}', '{{$teamID}}')">DFA</button>
                                        <button class="button {{if .OnTradeBlock}}button-warning{{end}}" onclick="toggleTradeBlock('{{.ID}}', '{{$teamID}}', {{not .OnTradeBlock}})" title="{{if .OnTradeBlock}}Remove from Trade Block{{else}}Add to Trade Block{{end}}">TB</button>
                                    {{end}}
                                {{end}}
                            </div>
                        </td>
                        <td><strong><a href="/player/{{.ID}}">{{.FirstName}} {{.LastName}}</a></strong></td>
                        <td>{{.Position}}</td>
                        <td>{{.MLBTeam}}</td>
                        <td>{{.Status}}</td>
                        {{$p := .}}
                        {{range $years}}
                            {{$isOptionYear := index $p.ContractOptionYears .}}
                            <td{{if $isOptionYear}} class="option-year"{{end}}>
                                {{$val := index $p.Contracts .}}
                                {{if $val}}{{if or (eq $val "TC") (eq $val "ARB") (eq $val "UFA")}} {{$val}} {{else}}${{formatMoney $val}}{{end}}{{else}}--{{end}}
                            </td>
                        {{end}}
                    </tr>
                    {{end}}
                {{end}}
            </tbody>
        </table>
    </div>
{{end}}
