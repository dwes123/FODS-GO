{{define "title"}}{{.Player.FirstName}} {{.Player.LastName}}{{end}}

{{define "content"}}
<div class="player-profile">
    <h2>{{.Player.FirstName}} {{.Player.LastName}}</h2>
    <div class="player-meta-grid">
        <div class="meta-card">
            <p><strong>Position:</strong> {{.Player.Position}}</p>
            <p><strong>MLB Team:</strong> {{.Player.MLBTeam}}</p>
            <p><strong>Status:</strong> {{.Player.Status}}</p>
            {{if .IsRostered}}<p><strong>Fantasy Team:</strong> {{.TeamName}}</p>{{end}}
        </div>
        <div class="meta-card">
            <p><strong>40-Man:</strong> {{if .Player.Status40Man}}Yes{{else}}No{{end}}</p>
            <p><strong>26-Man:</strong> {{if .Player.Status26Man}}Yes{{else}}No{{end}}</p>
            <p><strong>Option Years:</strong> {{.Player.OptionYears}}</p>
            {{if .Player.Rule5Year}}<p><strong>Rule 5 Eligibility:</strong> {{.Player.Rule5Year}}</p>{{end}}
        </div>
    </div>

    {{if .Player.BidEndTime}}
    <div class="bid-status-banner" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <h3 style="margin: 0 0 8px 0; color: #856404;">Active Bid</h3>
        <p style="margin: 0;"><strong>Current Bid:</strong> ${{formatMoney .Player.PendingBidAmount}} by <strong>{{.Player.PendingBidTeamName}}</strong></p>
        <p style="margin: 4px 0 0 0;"><strong>Bid Expires:</strong> <span id="bid-countdown" data-end="{{.Player.BidEndTime.Format "2006-01-02T15:04:05Z"}}"></span></p>
    </div>
    <script>
    (function() {
        var el = document.getElementById('bid-countdown');
        var end = new Date(el.getAttribute('data-end'));
        function update() {
            var now = new Date();
            var diff = end - now;
            if (diff <= 0) { el.textContent = 'Expired'; return; }
            var h = Math.floor(diff / 3600000);
            var m = Math.floor((diff % 3600000) / 60000);
            var s = Math.floor((diff % 60000) / 1000);
            el.textContent = h + 'h ' + m + 'm ' + s + 's remaining';
            setTimeout(update, 1000);
        }
        update();
    })();
    </script>
    {{end}}

    <h3>Contract Details (2026 - 2040)</h3>
    <div class="table-container">
        <table class="fantasy-table-base">
            <thead>
                <tr>{{range $year, $val := .Player.Contracts}}<th>{{$year}}</th>{{end}}</tr>
            </thead>
            <tbody>
                <tr>
                    {{range $year, $val := .Player.Contracts}}
                        <td>{{if $val}}{{if or (eq $val "TC") (eq $val "UFA") (hasPrefix $val "ARB")}}{{$val}}{{else}}${{formatMoney $val}}{{end}}{{else}}--{{end}}</td>
                    {{end}}
                </tr>
            </tbody>
        </table>
    </div>

    {{if .IsOwner}}
        <!-- OWNER ACTIONS -->
        <div class="owner-tools">
            <div class="tool-section">
                <h3>Contract Extension Calculator</h3>
                <form id="extensionForm">
                    <input type="hidden" name="player_id" value="{{.Player.ID}}">

                    <div class="position-tabs">
                        <button type="button" class="pos-tab active" data-pos="auto" onclick="setPositionType(this)">Auto ({{.Player.Position}})</button>
                        <button type="button" class="pos-tab" data-pos="SP" onclick="setPositionType(this)">SP</button>
                        <button type="button" class="pos-tab" data-pos="RP" onclick="setPositionType(this)">RP</button>
                        <button type="button" class="pos-tab" data-pos="hitter" onclick="setPositionType(this)">Hitter</button>
                    </div>

                    <div class="war-inputs">
                        <div class="form-group">
                            <label>1-Year WAR (estimates 3yr):</label>
                            <input type="number" id="ext_war_1yr" step="0.1" placeholder="0.0" oninput="updateWARFrom1yr()">
                        </div>
                        <div class="form-group">
                            <label>2-Year WAR (estimates 3yr):</label>
                            <input type="number" id="ext_war_2yr" step="0.1" placeholder="0.0" oninput="updateWARFrom2yr()">
                        </div>
                        <div class="form-group">
                            <label><strong>3-Year WAR Total:</strong></label>
                            <input type="number" id="ext_war" step="0.1" placeholder="0.0" required>
                        </div>
                    </div>
                    <button type="button" class="button button-info" onclick="calcExtension()">Calculate Offers</button>

                    <div id="ext_results" style="margin-top: 15px;"></div>
                </form>
            </div>

            <div class="tool-section">
                <h3>Contract Restructure</h3>
                <p class="note">Move up to 50% of salary from one year to another.</p>
                <form id="restructureForm">
                    <input type="hidden" name="player_id" value="{{.Player.ID}}">
                    <input type="hidden" name="team_id" value="{{.TeamID}}">
                    <div class="form-row">
                        <div class="form-group">
                            <label>From Year:</label>
                            <select name="from_year">
                                {{range $year, $val := .Player.Contracts}}{{if ne $val ""}}<option value="{{$year}}">{{$year}}</option>{{end}}{{end}}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>To Year:</label>
                            <select name="to_year">
                                {{range $year, $val := .Player.Contracts}}{{if ne $val ""}}<option value="{{$year}}">{{$year}}</option>{{end}}{{end}}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount ($):</label>
                            <input type="number" name="amount" min="0" step="10000">
                        </div>
                    </div>
                    <button type="button" class="button" onclick="submitRestructure()">Process Restructure</button>
                </form>
            </div>
        </div>

    {{else if .IsRostered}}
        <!-- TRADE ACTION -->
        <div class="action-bar">
            <h3>Interested in this player?</h3>
            <a href="/trades/new?team_id={{.TeamID}}" class="button button-primary">Propose Trade to {{.TeamName}}</a>
        </div>

    {{else}}
        {{if .Player.IsIFA}}
        <!-- IFA SIGNING (ISBP) -->
        <div class="bid-section ifa-bid-section">
            <h3><span class="ifa-badge">IFA</span> International Free Agent Signing</h3>
            <p class="ifa-note">IFA signings are paid from your team's ISBP balance.</p>
            <p><strong>Your ISBP Balance:</strong> ${{formatMoney .IsbpBalance}}</p>
            <form action="/bid" method="POST" class="bid-form">
                <input type="hidden" name="player_id" value="{{.Player.ID}}">
                <input type="hidden" name="years" value="1">
                <input type="hidden" name="ifa" value="1">
                <div class="form-group">
                    <label>ISBP $ Amount:</label>
                    <input type="number" name="aav" id="ifa_amount" value="100000" min="1" step="1">
                </div>
                <button type="submit" class="button button-ifa">Sign with ISBP</button>
            </form>
        </div>
        {{else}}
        <!-- FREE AGENT BIDDING -->
        <div class="bid-section">
            <h3>Make an Offer</h3>
            <form action="/bid" method="POST" class="bid-form">
                <input type="hidden" name="player_id" value="{{.Player.ID}}">
                <div class="form-group">
                    <label>Contract Length:</label>
                    <select name="years" id="bid_years">
                        <option value="1">1 Year</option>
                        <option value="2">2 Years</option>
                        <option value="3">3 Years</option>
                        <option value="4">4 Years</option>
                        <option value="5">5 Years</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>AAV ($):</label>
                    <input type="number" name="aav" id="bid_aav" value="760000" min="760000" step="1">
                </div>
                <p><strong>Bid Points:</strong> <span id="bid_points">1.52</span></p>
                <button type="submit" class="button">Submit Bid</button>
            </form>
        </div>
        {{end}}
    {{end}}

    <!-- BID HISTORY -->
    {{if .BidHistory}}
    <div class="bid-history-section">
        <details>
            <summary><strong>Bid History ({{len .BidHistory}} bids)</strong></summary>
            <table class="fantasy-table-base" style="margin-top: 10px;">
                <thead>
                    <tr><th>Team</th><th>Bid Points</th><th>Years</th><th>AAV</th><th>Date</th></tr>
                </thead>
                <tbody>
                    {{range .BidHistory}}
                    <tr>
                        <td>{{.TeamName}}</td>
                        <td>{{printf "%.2f" .Amount}}</td>
                        <td>{{.Years}}</td>
                        <td>${{formatMoney .AAV}}</td>
                        <td>{{.BidDate}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </details>
    </div>
    {{end}}

    <!-- ROSTER MOVES LOG -->
    {{if .Player.RosterMovesLog}}
    <div class="moves-log-section">
        <h3>Roster History</h3>
        <table class="fantasy-table-base">
            <thead>
                <tr><th>Date</th><th>Move</th></tr>
            </thead>
            <tbody>
                {{range .Player.RosterMovesLog}}
                <tr>
                    <td>{{.Date}}</td>
                    <td>{{.Type}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{end}}

    <!-- DEAD CAP -->
    {{if .DeadCap}}
    <div class="moves-log-section">
        <h3>Dead Cap Penalties</h3>
        <table class="fantasy-table-base">
            <thead>
                <tr><th>Team</th><th>Year</th><th>Amount</th><th>Note</th></tr>
            </thead>
            <tbody>
                {{range .DeadCap}}
                <tr>
                    <td>{{.TeamName}}</td>
                    <td>{{.Year}}</td>
                    <td>${{formatMoney .Amount}}</td>
                    <td>{{.Note}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{end}}

    <!-- GAME LOG (AJAX-loaded, position-aware) -->
    <div id="game-log-section" class="moves-log-section" style="display:none;">
        <h3>Game Log</h3>
        <div class="table-container">
            <table class="fantasy-table-base" style="min-width: auto;">
                <thead id="game-log-head"></thead>
                <tbody id="game-log-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- GAME LOG LOADER (position-aware) ---
(function() {
    var pos = '{{.Player.Position}}';
    var isPitcher = (pos === 'SP' || pos === 'RP');
    var statType = isPitcher ? 'pitching' : 'hitting';

    fetch('/api/player/{{.Player.ID}}/gamelog?type=' + statType)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!data.games || data.games.length === 0) return;
            var section = document.getElementById('game-log-section');
            var thead = document.getElementById('game-log-head');
            var tbody = document.getElementById('game-log-body');
            section.style.display = '';

            var ptsStyle = 'font-weight:bold; color: var(--fod-orange-accent, #E87426);';

            if (isPitcher) {
                thead.innerHTML = '<tr><th>Date</th><th>Opp</th><th>IP</th><th>K</th><th>ER</th><th>BB</th><th>HR</th><th>QS</th><th>SV</th><th>HLD</th><th style="' + ptsStyle + '">Pts</th></tr>';
                data.games.forEach(function(g) {
                    var s = g.raw_stats || {};
                    tbody.innerHTML += '<tr>' +
                        '<td>' + g.game_date + '</td>' +
                        '<td>' + (g.opponent || '') + '</td>' +
                        '<td>' + (s.ip != null ? s.ip.toFixed(1) : '0.0') + '</td>' +
                        '<td>' + (s.k || 0) + '</td>' +
                        '<td>' + (s.er || 0) + '</td>' +
                        '<td>' + (s.bb || 0) + '</td>' +
                        '<td>' + (s.hra || 0) + '</td>' +
                        '<td>' + (s.qs || 0) + '</td>' +
                        '<td>' + (s.sv || 0) + '</td>' +
                        '<td>' + (s.hld || 0) + '</td>' +
                        '<td style="font-weight:bold;">' + g.fantasy_points.toFixed(1) + '</td>' +
                        '</tr>';
                });
            } else {
                thead.innerHTML = '<tr><th>Date</th><th>Opp</th><th>H</th><th>HR</th><th>RBI</th><th>R</th><th>BB</th><th>SB</th><th>K</th><th>CS</th><th style="' + ptsStyle + '">Pts</th></tr>';
                data.games.forEach(function(g) {
                    var s = g.raw_stats || {};
                    tbody.innerHTML += '<tr>' +
                        '<td>' + g.game_date + '</td>' +
                        '<td>' + (g.opponent || '') + '</td>' +
                        '<td>' + (s.h || 0) + '</td>' +
                        '<td>' + (s.hr || 0) + '</td>' +
                        '<td>' + (s.rbi || 0) + '</td>' +
                        '<td>' + (s.r || 0) + '</td>' +
                        '<td>' + (s.bb || 0) + '</td>' +
                        '<td>' + (s.sb || 0) + '</td>' +
                        '<td>' + (s.k || 0) + '</td>' +
                        '<td>' + (s.cs || 0) + '</td>' +
                        '<td style="font-weight:bold;">' + g.fantasy_points.toFixed(1) + '</td>' +
                        '</tr>';
                });
            }
        })
        .catch(function() {});
})();

// --- EXTENSION CALCULATOR (WAR-based pricing from PHP) ---
let posOverride = null;

function setPositionType(btn) {
    document.querySelectorAll('.pos-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    posOverride = btn.dataset.pos === 'auto' ? null : btn.dataset.pos;
}

function updateWARFrom1yr() {
    const val = parseFloat(document.getElementById('ext_war_1yr').value);
    if (!isNaN(val)) document.getElementById('ext_war').value = (val * 3).toFixed(1);
}

function updateWARFrom2yr() {
    const val = parseFloat(document.getElementById('ext_war_2yr').value);
    if (!isNaN(val)) document.getElementById('ext_war').value = ((val / 2) * 3).toFixed(1);
}

function calcExtension() {
    const war3yr = parseFloat(document.getElementById('ext_war').value);
    if (!war3yr || war3yr <= 0) { alert('Enter a valid WAR value'); return; }

    const position = posOverride || '{{.Player.Position}}';
    let baseRate;
    if (position === 'SP') {
        baseRate = 3.3755;
    } else if (position === 'RP') {
        baseRate = 5.0131;
    } else {
        baseRate = 2.8354;
    }

    const decayFactors = [1.0, 0.926, 0.852, 0.796, 0.741, 0.704, 0.667, 0.667];
    const minAAV = 700000;

    let html = '<table class="fantasy-table-base"><thead><tr><th>Years</th><th>AAV</th><th>Total</th><th>Action</th></tr></thead><tbody>';

    for (let years = 1; years <= 8; years++) {
        const aav = Math.max(war3yr * baseRate * decayFactors[years - 1] * 1000000, minAAV);
        const total = aav * years;
        html += '<tr>' +
            '<td>' + years + '</td>' +
            '<td>$' + Math.round(aav).toLocaleString() + '</td>' +
            '<td>$' + Math.round(total).toLocaleString() + '</td>' +
            '<td><button class="button button-small" onclick="submitExtension(' + years + ', ' + Math.round(aav) + ')">Select</button></td>' +
            '</tr>';
    }
    html += '</tbody></table>';
    document.getElementById('ext_results').innerHTML = html;
}

async function submitExtension(years, aav) {
    if (!confirm('Submit request for ' + years + ' years at $' + aav.toLocaleString() + '?')) return;

    const formData = new FormData();
    formData.append('player_id', '{{.Player.ID}}');
    formData.append('years', years);
    formData.append('aav', aav);

    try {
        const res = await fetch('/extension', { method: 'POST', body: formData });
        const json = await res.json();
        if (res.ok) {
            alert(json.message);
            location.reload();
        } else {
            alert("Error: " + json.error);
        }
    } catch (e) {
        alert("Request failed");
    }
}

// --- RESTRUCTURE LOGIC ---
async function submitRestructure() {
    const form = document.getElementById('restructureForm');
    const formData = new FormData(form);

    try {
        const res = await fetch('/restructure', { method: 'POST', body: formData });
        const json = await res.json();

        if (res.ok) {
            alert(json.message);
            location.reload();
        } else {
            alert("Error: " + json.error);
        }
    } catch (e) {
        alert("Request failed");
    }
}

// --- BIDDING LOGIC ---
if (document.getElementById('bid_years')) {
    const multipliers = { 1: 2.0, 2: 1.8, 3: 1.6, 4: 1.4, 5: 1.2 };
    function calculatePoints() {
        const years = parseInt(document.getElementById('bid_years').value);
        const aav = parseFloat(document.getElementById('bid_aav').value);
        const points = (years * aav * multipliers[years]) / 1000000;
        document.getElementById('bid_points').innerText = points.toFixed(2);
    }
    document.getElementById('bid_years').addEventListener('change', calculatePoints);
    document.getElementById('bid_aav').addEventListener('input', calculatePoints);
}

</script>

<style>
    .player-profile { background: white; padding: 20px; border-radius: 8px; }
    .player-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .meta-card { background: var(--fod-gray-light); padding: 15px; border-radius: 6px; }

    .owner-tools { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
    .tool-section { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
    .note { font-size: 0.85rem; color: #666; margin-bottom: 15px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

    .position-tabs { display: flex; gap: 8px; margin-bottom: 15px; }
    .pos-tab { padding: 6px 14px; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .pos-tab.active { background: var(--fod-blue-primary); color: white; border-color: var(--fod-blue-primary); }
    .war-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    .action-bar { margin-top: 30px; text-align: center; background: #eef; padding: 30px; border-radius: 8px; }
    .table-container { overflow-x: auto; margin-bottom: 2rem; }
    .fantasy-table-base { width: 100%; min-width: 800px; margin: 0; }

    .moves-log-section { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
    .moves-log-section .fantasy-table-base { min-width: auto; }

    .ifa-bid-section { border: 2px solid var(--fod-orange-accent); background: #fff8f0; }
    .ifa-bid-section h3 { display: flex; align-items: center; gap: 8px; }
    .ifa-badge { display: inline-block; background: var(--fod-orange-accent); color: white; font-size: 0.75em; font-weight: bold; padding: 2px 6px; border-radius: 4px; vertical-align: middle; }
    .ifa-note { font-size: 0.9em; color: #856404; margin-bottom: 10px; }
    .button-ifa { background: var(--fod-orange-accent); border-color: var(--fod-orange-accent); }
    .button-ifa:hover { background: #c65e1a; }
</style>
{{end}}
