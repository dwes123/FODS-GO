{{define "title"}}AI Assistant{{end}}

{{define "content"}}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h2 style="margin: 0; border: none; padding: 0;">Commissioner AI Assistant</h2>
    <a href="/admin/" class="button button-small" style="background: var(--fod-blue-primary);">Back to Dashboard</a>
</div>

<div id="chat-container" style="display: flex; flex-direction: column; height: calc(100vh - 220px); background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
    <div id="messages" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;">
        <div class="msg assistant-msg">
            <div class="msg-bubble assistant-bubble">
                Hello! I'm your commissioner assistant. I can help you search players, check team balances, move players between teams, fix player names, run queries, and more. What would you like to do?
            </div>
        </div>
    </div>

    <div id="input-area" style="border-top: 2px solid var(--fod-blue-primary); padding: 15px; display: flex; gap: 10px; background: var(--fod-gray-light);">
        <input type="text" id="user-input" placeholder="Ask me anything about your leagues..."
            style="flex: 1; padding: 12px 16px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; outline: none;"
            autocomplete="off">
        <button id="send-btn" onclick="sendMessage()" class="button" style="padding: 12px 24px; min-width: 80px;">
            Send
        </button>
    </div>
</div>

<style>
    .msg {
        display: flex;
        max-width: 85%;
    }
    .user-msg {
        align-self: flex-end;
    }
    .assistant-msg {
        align-self: flex-start;
    }
    .msg-bubble {
        padding: 10px 16px;
        border-radius: 12px;
        line-height: 1.5;
        font-size: 14px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .user-bubble {
        background: var(--fod-blue-primary);
        color: white;
        border-bottom-right-radius: 4px;
    }
    .assistant-bubble {
        background: #f0f0f0;
        color: var(--fod-gray-dark);
        border-bottom-left-radius: 4px;
    }
    .tool-calls-section {
        margin-top: 8px;
        font-size: 12px;
    }
    .tool-calls-toggle {
        cursor: pointer;
        color: var(--fod-blue-primary);
        font-weight: 600;
        user-select: none;
    }
    .tool-calls-toggle:hover {
        text-decoration: underline;
    }
    .tool-calls-list {
        display: none;
        margin-top: 6px;
        padding: 8px;
        background: #e8e8e8;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
    }
    .tool-call-item {
        margin-bottom: 4px;
        padding: 4px 0;
        border-bottom: 1px solid #ddd;
    }
    .tool-call-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .tool-name {
        font-weight: bold;
        color: var(--fod-orange-accent);
    }
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 10px 16px;
    }
    .typing-dot {
        width: 8px;
        height: 8px;
        background: #999;
        border-radius: 50%;
        animation: typing 1.2s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
        0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
        30% { opacity: 1; transform: scale(1); }
    }
    #user-input:focus {
        border-color: var(--fod-blue-primary);
        box-shadow: 0 0 0 2px rgba(46, 109, 164, 0.2);
    }
    #send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>

<script>
    const messagesDiv = document.getElementById('messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // Conversation history sent to the backend
    let history = [];

    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // Add user message to UI
        appendMessage('user', text);
        history.push({ role: 'user', content: text });
        userInput.value = '';

        // Show typing indicator
        const typingId = showTyping();
        setLoading(true);

        fetch('/admin/agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, history: history.slice(0, -1) })
        })
        .then(r => {
            if (!r.ok) throw new Error('Request failed');
            return r.json();
        })
        .then(data => {
            removeTyping(typingId);
            if (data.error) {
                appendMessage('assistant', 'Error: ' + data.error);
            } else {
                appendMessage('assistant', data.response, data.tool_calls);
                history.push({ role: 'assistant', content: data.response });
            }
        })
        .catch(err => {
            removeTyping(typingId);
            appendMessage('assistant', 'Something went wrong. Please try again.');
        })
        .finally(() => {
            setLoading(false);
            userInput.focus();
        });
    }

    function appendMessage(role, text, toolCalls) {
        const wrapper = document.createElement('div');
        wrapper.className = 'msg ' + (role === 'user' ? 'user-msg' : 'assistant-msg');

        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble ' + (role === 'user' ? 'user-bubble' : 'assistant-bubble');
        if (role === 'user') {
            bubble.textContent = text;
        } else {
            bubble.innerHTML = formatMarkdown(text);
        }

        wrapper.appendChild(bubble);

        // Add collapsible tool calls section
        if (toolCalls && toolCalls.length > 0) {
            const toolSection = document.createElement('div');
            toolSection.className = 'tool-calls-section';

            const toggle = document.createElement('div');
            toggle.className = 'tool-calls-toggle';
            toggle.textContent = 'Actions taken (' + toolCalls.length + ')';
            toggle.onclick = function() {
                const list = this.nextElementSibling;
                list.style.display = list.style.display === 'none' ? 'block' : 'none';
            };

            const list = document.createElement('div');
            list.className = 'tool-calls-list';
            toolCalls.forEach(tc => {
                const item = document.createElement('div');
                item.className = 'tool-call-item';
                item.innerHTML = '<span class="tool-name">' + escapeHtml(tc.name) + '</span>(' +
                    escapeHtml(JSON.stringify(tc.args)) + ')';
                list.appendChild(item);
            });

            toolSection.appendChild(toggle);
            toolSection.appendChild(list);
            bubble.appendChild(toolSection);
        }

        messagesDiv.appendChild(wrapper);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTyping() {
        const id = 'typing-' + Date.now();
        const wrapper = document.createElement('div');
        wrapper.className = 'msg assistant-msg';
        wrapper.id = id;
        wrapper.innerHTML = '<div class="msg-bubble assistant-bubble typing-indicator">' +
            '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
        messagesDiv.appendChild(wrapper);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return id;
    }

    function removeTyping(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function setLoading(loading) {
        sendBtn.disabled = loading;
        userInput.disabled = loading;
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatMarkdown(text) {
        // Escape HTML first, then apply markdown formatting
        let html = escapeHtml(text);
        // Bold: **text**
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // Italic: *text*
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // Inline code: `text`
        html = html.replace(/`(.+?)`/g, '<code style="background:#e0e0e0;padding:1px 4px;border-radius:3px;">$1</code>');
        // Line breaks
        html = html.replace(/\n/g, '<br>');
        return html;
    }

    // Focus input on load
    userInput.focus();
</script>
{{end}}
